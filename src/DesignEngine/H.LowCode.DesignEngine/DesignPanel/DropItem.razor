@inject DragDropStateService DragDropStateService

<div class="dropitem-box @DropItemBoxClassMapper.Class" style="float:left; opacity:@ComponentSchema.Opacity; @Style
    width: @(ComponentSchema.ComponentPropertySchema.ItemWidth/24*100)%;
    min-height: @(ComponentSchema.ComponentPropertySchema.ItemHeight)px;
    @ComponentSchema.ComponentPropertySchema.CustomStyle">
    <div class="dropitem @DropItemClassMapper.Class" style="@ComponentSchema.ComponentPropertySchema.Style"
         @onclick="OnClick" @onclick:stopPropagation 
         @ondragstart="OnDragStart"
         @ondragenter="OnDragEnter"
         @ondragover="OnDragOver" @ondragover:preventDefault @ondragover:stopPropagation
         @ondragleave="OnDragLeave">

        @if (ComponentSchema.IsSelected)
        {
            <div draggable="true" class="dropitem-icon-move">
                <Icon Type="drag" Theme="outline" />
            </div>
            <div class="dropitem-pointer-wrapper">
                <div class="dropitem-pointer" @onclick="OnDelete">
                    <Icon Type="delete" Theme="outline" />
                </div>
                <div class="dropitem-pointer" @onclick="OnCopy">
                    <Icon Type="copy" Theme="outline" />
                </div>
            </div>
        }
        @if (ComponentSchema.IsHiddenTitle == false)
        {
            <div class="dropitem-title">@ComponentSchema.ComponentPropertySchema.Title ：</div>
        }

        @if(ComponentSchema.ComponentCategory == ComponentCategory.Basic)
        {
            <div class="dropitem-div-component">@ComponentSchema.RenderFragment(ComponentSchema)</div>
        }
        else
        {
            <div class="dropitem-div-container">@ComponentSchema.RenderFragment(ComponentSchema)</div>
        }
    </div>
</div>

@code {
    [Parameter]
    public ComponentSchema ComponentSchema { get; set; }

    [Parameter]
    public Action<ComponentSchema> OnItemClick { get; set; }

    [Parameter]
    public Action<ComponentSchema> OnItemDelete { get; set; }

    [Parameter]
    public Action<ComponentSchema> OnItemCopy { get; set; }

    [Parameter]
    public string Style { get; set; }

    protected ClassMapper DropItemBoxClassMapper { get; } = new ClassMapper();
    protected ClassMapper DropItemClassMapper { get; } = new ClassMapper();

    protected override void OnInitialized()
    {
        RegisterEventDispatcher();
        SetClassMap();
        InitData();

        base.OnInitialized();
    }

    private void SetClassMap()
    {
        DropItemClassMapper.Clear()
            .If("dropitem-selected", () => ComponentSchema.IsSelected)
            .If("dropitem-component", () => ComponentSchema.ComponentCategory == ComponentCategory.Basic)
            .If("dropitem-container", () => ComponentSchema.ComponentCategory != ComponentCategory.Basic);

        Console.WriteLine($"ItemHeight: {ComponentSchema.ComponentPropertySchema.ItemHeight}");
        DropItemBoxClassMapper.Clear()
            .If("dropitem-box-layout", () => ComponentSchema.ComponentCategory != ComponentCategory.Basic);
    }

    private void InitData()
    {
        ComponentSchema.ComponentPropertySchema.Name = $"{ComponentSchema.ComponentType}_{Random.Shared.Next(100, 999)}";
    }

    private void OnClick()
    {
        OnItemClick.Invoke(ComponentSchema);
        BlazorEventDispatcher.Trigger("designengine.dropitem.onclick", ComponentSchema);
    }

    private void OnDragStart(DragEventArgs dragEventArgs)
    {
        //ComponentSchema.Opacity = 0.2;

        //记录当前选中对象
        DragDropStateService.CurrentDragComponent = ComponentSchema;
    }

    private void OnDragEnter(DragEventArgs dragEventArgs)
    {
        DragDropStateService.LastDragOverComponent = ComponentSchema;
    }

    private void OnDragOver(DragEventArgs dragEventArgs)
    {
        if (DragDropStateService.CurrentDragComponent == ComponentSchema)
            return;

        if (DateTime.Now < DragDropStateService.LastDragOverTime.AddMilliseconds(200))
            return;

        //设置移动位置样式，拖拽到目标元素上半部分时，上方添加红色边框，下半部分时下方添加红色边框
        if (dragEventArgs.OffsetY < 30)
        {
            Console.WriteLine($"top: OffsetY:{dragEventArgs.OffsetY}");
            ComponentSchema.ComponentPropertySchema.Style = "border-top: 2px dashed #1890ff;";
            ComponentSchema.IsDroppedToBack = false;
        }
        else
        {
            Console.WriteLine($"bottom: OffsetY:{dragEventArgs.OffsetY}");
            ComponentSchema.ComponentPropertySchema.Style = "border-bottom: 2px dashed #1890ff; height: auto;";
            ComponentSchema.IsDroppedToBack = true;
        }
        DragDropStateService.LastDragOverTime = DateTime.Now;
    }

    private void OnDragLeave()
    {
        //如果当前被拖拽的组件和拖拽到上面的组件是同一个，直接返回
        if (DragDropStateService.CurrentDragComponent == ComponentSchema)
            return;

        ComponentSchema.ComponentPropertySchema.Style = string.Empty;
    }

    private void OnDelete()
    {
        OnItemDelete.Invoke(ComponentSchema);
    }

    private void OnCopy()
    {
        OnItemCopy.Invoke(ComponentSchema);
    }

    private void RegisterEventDispatcher()
    {
        //订阅设计面板中的组件点击事件
        BlazorEventDispatcher.RegisterEvent("designengine.dropitem.onclick", (value) =>
        {
            //取消选中项
            if (DragDropStateService.LastSelectedComponent != ComponentSchema)
            {
                ComponentSchema.IsSelected = false;
                StateHasChanged();
            }
        });

        //订阅属性面板中的事件
        BlazorEventDispatcher.RegisterEvent("designengine.propertysetting.onchange", (value) =>
        {
            StateHasChanged();
        });
    }
}